name: Deprecation Monitoring

# Default permissions: read-only for security
permissions:
  contents: read

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Mondays at 9 AM UTC to catch new deprecations in dependencies
    - cron: '0 9 * * 1'

jobs:
  deprecation-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Prevent resource consumption attacks
    permissions:
      contents: read               # Required to checkout code
      actions: write              # Required to upload artifacts
      issues: write               # Required to create issues
      pull-requests: write        # Required to comment on PRs
    
    steps:
    - name: Checkout code
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      
    - name: Set up Go
      uses: actions/setup-go@d35c59abb061a4a6fb18e82ac0862c26744d6ab5 # v5.5.0
      with:
        go-version: '1.24' # Use latest stable for deprecation analysis
        
    - name: Cache Go modules
      uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
          
    - name: ðŸ”’ Install Verified Tools
      run: |
        # Install verified security tools with checksum verification
        ./scripts/security-utils.sh install golangci-lint
        echo "$(./scripts/security-utils.sh get-path golangci-lint)" >> $GITHUB_PATH
        
    - name: Check for deprecation warnings
      id: deprecation-check
      run: |
        echo "Scanning for deprecation warnings..."
        
        # Run staticcheck to find SA1019 (deprecated) warnings
        golangci-lint run --enable=staticcheck --disable-all --out-format=line-number 2>&1 | \
        grep -E "SA1019|deprecated" > deprecations.txt || true
        
        # Count deprecations
        DEPRECATION_COUNT=$(wc -l < deprecations.txt || echo "0")
        echo "deprecation_count=$DEPRECATION_COUNT" >> $GITHUB_OUTPUT
        
        # Create summary
        if [ "$DEPRECATION_COUNT" -gt 0 ]; then
          echo "## ðŸš¨ Deprecation Warnings Found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Found $DEPRECATION_COUNT deprecation warning(s):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          cat deprecations.txt >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please review and update deprecated API usage according to the [Deprecation Migration Plan](DEPRECATION_MIGRATION_PLAN.md)." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âœ… No Deprecation Warnings" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All code is using current, non-deprecated APIs. Great job! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
        fi
        
    - name: Upload deprecation report
      if: steps.deprecation-check.outputs.deprecation_count > 0
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: deprecation-report-${{ github.sha }}
        path: deprecations.txt
        retention-days: 30
        
    - name: Comment on PR with deprecation status
      if: github.event_name == 'pull_request'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const fs = require('fs');
          const deprecationCount = ${{ steps.deprecation-check.outputs.deprecation_count }};
          
          let comment = '';
          if (deprecationCount > 0) {
            const deprecations = fs.readFileSync('deprecations.txt', 'utf8');
            comment = `## ðŸš¨ Deprecation Warnings Detected
          
          This PR introduces or contains **${deprecationCount}** deprecation warning(s):
          
          \`\`\`
          ${deprecations}
          \`\`\`
          
          Please review and update deprecated API usage according to the [Deprecation Migration Plan](DEPRECATION_MIGRATION_PLAN.md).
          
          **Action Required:** Fix deprecations before merging to maintain code quality.`;
          } else {
            comment = `## âœ… No Deprecation Warnings
          
          Great! This PR doesn't introduce any new deprecation warnings. All APIs are current and supported.`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: Fail on new deprecations in PR
      if: github.event_name == 'pull_request' && steps.deprecation-check.outputs.deprecation_count > 0
      run: |
        echo "::error::Found ${{ steps.deprecation-check.outputs.deprecation_count }} deprecation warning(s) in this PR"
        echo "Please fix deprecated API usage before merging"
        exit 1
        
    - name: Weekly deprecation summary
      if: github.event_name == 'schedule'
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          const deprecationCount = ${{ steps.deprecation-check.outputs.deprecation_count }};
          
          if (deprecationCount > 0) {
            const title = `Weekly Deprecation Report: ${deprecationCount} warning(s) found`;
            const body = `## ðŸ“Š Weekly Deprecation Monitoring Report
          
          **Date:** ${new Date().toISOString().split('T')[0]}
          **Status:** ${deprecationCount} deprecation warning(s) detected
          
          Please review the [latest workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
          
          **Next Steps:**
          1. Review deprecated API usage
          2. Plan migration according to [Deprecation Migration Plan](DEPRECATION_MIGRATION_PLAN.md)
          3. Update dependencies if needed
          4. Test replacements in staging environment
          
          **Auto-generated by:** [Deprecation Monitoring Workflow](.github/workflows/deprecation-monitoring.yml)`;
          
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'deprecation', 'technical-debt']
            });
          }